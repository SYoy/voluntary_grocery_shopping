<!DOCTYPE html>
<html lang="en"style="height: 100%">

<head>

  {% load static %}
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="description" content="Corona Einkaufshelfer">
  <meta name="author" content="Marius Steger">
  <meta http-equiv="refresh" content="300" >
  <title>Einkaufshelfer - offene Aufträge</title>

  <!-- Custom fonts for this theme -->
  <link href="{% static 'vendor/fontawesome-free/css/all.min.css' %}" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic" rel="stylesheet" type="text/css">

  <!-- Theme CSS -->
  <link href="{% static 'css/freelancer.min.css' %}" rel="stylesheet">

  <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-161194303-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-161194303-1');
    </script>

    <!-- Dialog Plugin -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <script src="{% static 'js/build_dialog/jquery.dialog.js' %}"></script>
    <link rel="stylesheet" href="{% static 'js/build_dialog/jquery.dialog.css' %}">

    <!-- Bootstrap
    <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet">
    <link href="{% static 'css/style.css' %}" rel="stylesheet">
    <link href="{% static 'css/themify-icons.css' %}" rel="stylesheet">
    <link href="{% static 'css/dosis-font.css' %}" rel="stylesheet" type='text/css'>
    -->

</head>

<body id="page-top" style="min-height: 100%;background: #99AEB5">
{% load widget_tweaks %}
  <!-- Navigation -->

  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg bg-secondary text-uppercase fixed-top" id="mainNav">
    <div class="container-fluid">
     {% if user.is_authenticated %}
      <a class="navbar-brand btn btn-success" href="{% url "logout" %}">Abmelden</a>
     {% else %}
        <form class="form-inline my-0 my-lg-0" role="form" action="{% url "login" %}"
            method="post" accept-charset="utf-8">
          <div class="form-group mr-sm-2 d-none d-md-block">
            <input type="text" placeholder="Benutzername" class="form-control" name="username">
          </div>
          <div class="form-group mr-sm-2 d-none d-md-block">
            <input type="password" placeholder="Passwort" class="form-control" name="password">
          </div>
          {% csrf_token %}
          <button type="submit" class="btn btn-success d-none d-md-block">Anmelden</button>
        </form>

         <form class="form-inline my-0 my-lg-0 d-md-none" role="form" action="{% url "login" %}"
            method="post" accept-charset="utf-8">
          <div class="form-group">
            <input type="text" placeholder="Benutzername" class="form-control" name="username" size="7">
          </div>
          <div class="form-group">
            <input type="password" placeholder="Passwort" class="form-control" name="password" size="7">
          </div>
          {% csrf_token %}
          <button type="submit" class="btn btn-success">Anmelden</button>
        </form>
     {% endif %}

    <button class="navbar-toggler navbar-toggler-right text-uppercase font-weight-bold bg-primary text-white rounded" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
        Menü
        <i class="fas fa-bars"></i>
      </button>
      <div class="collapse navbar-collapse" id="navbarResponsive">
        <ul class="navbar-nav ml-auto">
          <li class="nav-item mx-0 mx-lg-1">
            <a class="nav-link py-3 px-0 px-lg-3 rounded js-scroll-trigger" style="background: #eb9b72" href="{% url 'start' %}">Starseite</a>
          </li>
            {% if user.is_authenticated %}
              <li class="nav-item mx-0 mx-lg-1">
                <a class="nav-link py-3 px-0 px-lg-3 rounded js-scroll-trigger" style="background: #f27942" href="{% url 'home' %}">Mein Bereich</a>
              </li>
              <li class="nav-item mx-0 mx-lg-1">
                <a class="nav-link py-3 px-0 px-lg-3 rounded js-scroll-trigger" style="background: #f27942" href="{% url 'blackboard' %}">Schwarzes Brett</a>
              </li>
            {% else %}
              <li class="nav-item mx-0 mx-lg-1">
                <a class="nav-link py-3 px-0 px-lg-3 rounded js-scroll-trigger" style="background: #eb9b72" href="{% url 'public_blackboard' %}">Schwarzes Brett</a>
              </li>
            {% endif %}
          <li class="nav-item mx-0 mx-lg-1">
            <a class="nav-link py-3 px-0 px-lg-3 rounded js-scroll-trigger" style="background: #eb9b72" href="{% url 'faq' %}">Anleitung/FAQ</a>
          </li>
          <li class="nav-item mx-0 mx-lg-1">
            <a class="nav-link py-3 px-0 px-lg-3 rounded js-scroll-trigger" style="background: #eb9b72" href="{% url 'impressum' %}">Impressum</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>


    <header class="masthead" style="margin-top: -5rem; background: #f5dab2;">
      <div class="container-fluid">

        <div class="row justify-content-between" style="padding-top: 10px; padding-bottom: 10px; padding-left: 2rem; padding-right: 1rem;
                background: #7a8e95; border-radius: 20px">
                <div class="col-lg-6" style="background: #f5cd9a; font-size: 2.5rem; text-align: center; margin: auto; margin-bottom: 10px;
                    color: white; border-radius: 20px">
                    Aktuelle Einkaufsaufträge / Hilfsgesuche</div>


            <div class="col-lg-3 text-center" style="font-size: 20px; background: #8ea995; margin-left: 10px; padding-top: 4px; border-radius: 20px">
                    <div class="form-group" style="margin: auto; color:#ffffff; font-size: larger; border-radius: 20px">
                        Wählen Sie einen Ortsteil aus:
                        {{ form.location }}
                    </div>
                </div>
            </div>
        </div>

        <div class="row justify-content-center" style="padding-top: 10px; padding-bottom: 10px; padding-left: 2rem; padding-right: 1rem;">
            <!-- BLACKBOARD -->
            <div class="col-lg-12 img-rounded" id="blackboard" style="color: #ffffff; width: 100%;
            height: 100%; margin-top: 5px;">
                <div class="row content-ct" id="blackboard_elements"></div>
            </div>
        </div>


      </div>
  </header>

  <!-- jQuery (necessary for AJAX / JQuery JavaScript plugins) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>

<script>
function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

function onClickAuftrag(e) {
    var element = document.getElementById(e.id);

    dialog.confirm({
        message: "Möchten Sie den Einkauf übernehmen? \n" +
                "Er wird Ihren aktiven Aufträgen hinzugefügt und Sie erhalten die Telefonnumer der HilfsempfängerIn.\n" +
                "Bitte konktaktieren Sie anschließend Ihren Auftragsgeber.\n" +
                "Nach Annahme des Auftrags werden Sie automatisch zu Ihren angenommenen Aufträgen hinzugefügt.",
        cancel: "Nein",
        button: "Ja",
        required: true,
        callback: function(response){
            if (response) {
                $.ajax({
                    type: 'POST',
                    url: "{% url 'setInWork' %}",
                    data: {"id_listing": e.id,
                            'csrfmiddlewaretoken': '{{ csrf_token }}'},

                    success: function (response2) {
                        window.location.replace("/helfer_einkaufslisten/");
                        /*dialog.confirm({
                            message: "Der Auftrag wurde erfolgreich angenommen.\n" +
                                    "Möchten Sie zur Auftragsübersicht wechseln?",
                            cancel: "Nein",
                            button: "Ja",
                            required: true,
                            callback: function (response3) {
                                if (response3) {
                                    sleep(2000);
                                    window.location.replace("/home/");
                                } else {
                                    sleep(2000);
                                    window.location.reload();
                                }
                            }
                        });*/
                    },
                    error: function (response2) {
                        dialog.alert("Ihre Anfrage den Einkaufswunsch zu bearbeiten ist fehlgeschlagen, " +
                            "bitte versuchen Sie es in ein paar Minuten erneut oder wenden Sie \n" +
                            "sich an unsere Service-Email: helfer@uber.space")
                    }
                });
            }
        }
    });
}
</script>

<script>
function addElement(elementTag, elementId, dict, map) {
    // Adds an element to the document
    var p = document.getElementById("blackboard_elements");
    var newElement = document.createElement(elementTag);
    newElement.setAttribute('id', elementId);
    newElement.innerHTML = dict["nachricht"];

        newElement.className = 'col-sm-6 col-md-4 col-xl-2';
        newElement.innerHTML = '<div class="col-md12" style="padding-left: 3px; margin-bottom: 5px">Nachricht an die Helfer:</div>' +
        '<div class="col-md12" style="background: #798f96; padding-left: 3px; margin-bottom: 25px; border-radius: 5px"> '+
        dict["nachricht"]+'</div>'+
        '<div class="col-md12" style="padding-left: 3px; margin-bottom: 5px">Wunsch:</div>'+
        '<div class="col-md12" style="background: #99aeb5; padding-left: 3px; margin-bottom: 25px; border-radius: 5px"> '+
        dict["liste_text"]+'</div>'+
        '<div class="row justify-content-between">'+
        '<div class="col-3">'+'Budget: '+ dict["budget"]+ '€</div>'+
        '<div class="col-3">'+ 'Ort: '+ map[dict["user"]] +'</div>'
        +'</div>'
        ;

    // Css styling
    newElement.setAttribute("style", "background: #0f6674; float: left; text-align: " +
        "left; margin-right: 10px; padding: 5px; margin-bottom: 10px;" +
        "border-radius: 15px; border: 3px solid #798f96; cursor: pointer; padding-bottom: 5px");
    newElement.setAttribute("id", elementId);
    newElement.setAttribute("onclick","onClickAuftrag(this)");

    p.appendChild(newElement);
}

function clearElements(){
    var element = document.getElementById("blackboard_elements");
    while (element.firstChild) {
      element.removeChild(element.firstChild);
    }
}
function addNoElementsMessage(){
    var p = document.getElementById("blackboard_elements");
    var newElement = document.createElement("div");
    newElement.setAttribute('id', "NoElementsMessage");
    newElement.innerHTML = "Für Ihre Auswahl wurden keine Treffer gefunden, bitte vergrößern Sie Ihren Suchraum.";

    p.appendChild(newElement);
}

</script>
<script>
    function updateBlockboard(e, location, status) {
        e.preventDefault();
        // get the nickname
        // GET AJAX request
        $.ajax({
            type: 'GET',
            url: "{% url 'query_listings_blackboard' %}",
            data: {"location": location,
                    "status": status},

            success: function (response) {
                // if not valid user, alert the user
                if(response["valid"]){

                    var auftraege = JSON.parse(response["data"]);
                    if (auftraege.length > 0) {
                        clearElements();
                        auftraege.forEach(function(element) {
                            addElement("div", element["pk"], element["fields"], response["map"]);
                        });
                    } else {
                        clearElements();
                        addNoElementsMessage();
                    }
                }
            },
            error: function (response) {
                console.log(response)
            }
        })
    }
</script>
<script>
  /* query slected location listing*/
    $("#location").change(function (e) {
        var location = $(this).val();
        var status = "aktiv";

        updateBlockboard(e, location, status)
    })
</script>
</body>
</html>